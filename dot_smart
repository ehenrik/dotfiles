export AWS_CONFIGURE_SSO_DEFAULT_SSO_REGION=eu-central-1
export AWS_DEFAULT_REGION=eu-central-1
export AWS_REGION=eu-central-1
export AWS_SSO_CONFIG=/Users/henrikengman/.aws-sso/config.yaml
export AWS_CONFIGURE_SSO_DEFAULT_SSO_START_URL=https://smarteurope.awsapps.com/start#/
export AWS_CONFIGURE_SSO_DEFAULT_SSO_REGION=eu-central-1

# AWS SSO
sso() {
    unset AWS_PROFILE
    export AWS_PROFILE=$1
    aws sts get-caller-identity &> /dev/null || aws sso login --profile $1 || (unset AWS_PROFILE && 
aws-sso-util configure profile --no-credential-process $1)
    aws-export-credentials --credentials-file-profile $1 || aws sso login --profile $1 && 
aws-export-credentials --credentials-file-profile $1
    sed -i '/aws_credential_expiration/d' ${AWS_CONFIG_FILE:-~/.aws/config}
}

# AWS SSO completion
_sso() {
    local -a completions
    while IFS='\n' read -r comp; do
        if [ -n "$comp" ]; then
            completions+=${comp}
        fi
    done < <(grep '^\[profile.*\]$' ${AWS_CONFIG_FILE:-~/.aws/config} | sed 's/^\[profile \(.*\)\]$/\1/')
    IFS=\  compadd $(echo $completions[@])
}
